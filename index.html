<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weekly Customer Check-in Form</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#334155;--border:#1f2937;--fg:#e5e7eb;--acc:#22c55e;--warn:#f59e0b;--err:#ef4444}
    html,body{background:#0b1220;color:var(--fg);font-family: ui-sans-serif,system-ui,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    .wrap{max-width:980px;margin:40px auto;padding:24px}
    .card{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid var(--border);border-radius:18px;padding:24px;box-shadow: 0 10px 30px #00000030}
    h1{font-size:1.6rem;margin:0 0 12px}
    p.desc{color:#94a3b8;margin:0 0 18px}
    form{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full{grid-column:1/-1}
    label{display:block;font-size:.9rem;margin-bottom:6px;color:#cbd5e1}
    input,select,textarea,button{width:100%;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--fg);padding:12px}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .hint{font-size:.8rem;color:#94a3b8;margin-top:6px}
    .actions{display:flex;gap:12px}
    .btn{cursor:pointer;font-weight:600}
    .primary{background:linear-gradient(90deg,#16a34a,#22c55e);border:0;color:#062d13}
    .ghost{background:#0b1220;border-color:#263143}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);color:#9ca3af}
    .status{margin-top:10px}
    .ok{color:var(--acc)}
    .warn{color:var(--warn)}
    .err{color:var(--err)}
    .footer{margin-top:20px;color:#94a3b8;font-size:.85rem}
  </style>
  <!--
  üîß GOOGLE APPS SCRIPT ENDPOINTS

  // 1) Web App to RECEIVE submissions (POST)
  function doPost(e){
    const sheet = SpreadsheetApp.openById('PUT_SHEET_ID_HERE').getSheetByName('Responses');
    const data = JSON.parse(e.postData.contents);
    const values = [
      new Date(), // server timestamp
      data.memoDate,
      data.staff,
      data.company,
      Number(data.relationship),
      Number(data.proactiveness),
      data.keyActivity || '',
      data.clientFeedback || '',
      data.nextAction || '',
      data.summary || '',
      data.memo || ''
    ];
    sheet.appendRow(values);
    return ContentService.createTextOutput(JSON.stringify({ok:true}))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // 2) Web App to LIST companies (GET)
  //    Create a sheet named "CustomerList" with company names in column A (header in A1, data from A2)
  function doGet(e){
    const sheet = SpreadsheetApp.openById('PUT_SHEET_ID_HERE').getSheetByName('CustomerList');
    const values = sheet.getRange(2,1,sheet.getLastRow()-1,1).getValues()
      .map(r => (r[0]||'').toString().trim())
      .filter(v => v.length>0);
    return ContentService.createTextOutput(JSON.stringify({names: values}))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // Deploy each as a Web App (or one project handling both) and paste URLs below.
  -->
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Weekly Customer Check-in</h1>
      <p class="desc">‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 2 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Ä¢ ‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á <em>Memo</em> ‡πÅ‡∏•‡∏∞ <em>Memo Date</em> ‡∏Ñ‡∏£‡∏ö</p>

      <div class="pill">üß≠ Mode: Weekly ‚Ä¢ ‚è±Ô∏è Fast input</div>

      <form id="checkinForm" class="full" autocomplete="off">
        <div>
          <label>Memo Date</label>
          <input type="date" name="memoDate" required />
        </div>
        <div>
          <label>Staff</label>
          <input name="staff" list="staffList" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" required />
          <datalist id="staffList">
            <option value="Wim"></option>
            <option value="Cream"></option>
            <option value="Fern"></option>
            <option value="Tham"></option>
          </datalist>
        </div>

        <div class="full">
          <label>Company</label>
          <input name="company" list="companyList" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" required />
          <datalist id="companyList"></datalist>
          <div class="hint">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Google Sheet (CustomerList)</div>
        </div>

        <div class="row">
          <div>
            <label>Relationship (0‚Äì5)</label>
            <select name="relationship" required>
              <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</option>
              <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            </select>
            <div class="hint">0 = no contact ‚Ä¢ 5 = strong & cooperative</div>
          </div>
          <div>
            <label>Proactiveness (0‚Äì5)</label>
            <select name="proactiveness" required>
              <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</option>
              <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            </select>
            <div class="hint">0 = none ‚Ä¢ 5 = very proactive</div>
          </div>
        </div>

        <div class="full">
          <label>Key Activity This Week</label>
          <textarea name="keyActivity" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°"></textarea>
        </div>

        <div>
          <label>Client Feedback</label>
          <textarea name="clientFeedback" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î / ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö"></textarea>
        </div>
        <div>
          <label>Next Action</label>
          <textarea name="nextAction" placeholder="‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠"></textarea>
        </div>

        <div>
          <label>Summary Status</label>
          <select name="summary" required>
            <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option value="Active">‚úÖ Active</option>
            <option value="Follow-up">‚ö†Ô∏è Need Follow‚Äëup</option>
            <option value="No Response">‚ùå No Response</option>
          </select>
        </div>
        <div>
          <label>Memo / Note</label>
          <input name="memo" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" />
        </div>

        <div class="full actions">
          <button type="submit" class="btn primary">Submit</button>
          <button type="button" id="saveDraft" class="btn ghost">Save Draft (local)</button>
          <span id="status" class="status"></span>
        </div>
      </form>

      <div class="footer">
        ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ <code>ENDPOINT_SUBMIT</code> ‡πÅ‡∏•‡∏∞ <code>ENDPOINT_LIST</code> ‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó <b>CustomerList</b>
      </div>
    </div>
  </div>

  <script>
    // üëâ 1) ‡πÉ‡∏™‡πà URL Web App ‡∏Ç‡∏≠‡∏á Google Apps Script
    const ENDPOINT_SUBMIT = "https://script.google.com/macros/s/AKfycbxw7SrqM5V8mcqQWFxGSHh9dFgu1hILFqzwv9fQW59w5Y6fOcThPTgL6IkF3QCOmiaR/exec"; // doPost
    const ENDPOINT_LIST   = "https://script.google.com/macros/s/AKfycbxw7SrqM5V8mcqQWFxGSHh9dFgu1hILFqzwv9fQW59w5Y6fOcThPTgL6IkF3QCOmiaR/exec";   // doGet (returns {names:[]})

    const form = document.getElementById('checkinForm');
    const statusEl = document.getElementById('status');
    const companyList = document.getElementById('companyList');

    function setStatus(msg, cls){
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (cls||'');
    }

    // üëâ 2) Load company list from Google Sheet (with local cache)
    const CACHE_KEY = 'company-names-cache-v1';
    async function loadCompanies(){
      // try cache first
      const cached = localStorage.getItem(CACHE_KEY);
      if(cached){
        try{
          const names = JSON.parse(cached);
          renderCompanyOptions(names);
        }catch(_){/* ignore */}
      }
      try{
        const res = await fetch(ENDPOINT_LIST, {method:'GET'});
        const json = await res.json();
        if(Array.isArray(json.names)){
          const names = [...new Set(json.names)].sort((a,b)=>a.localeCompare(b));
          localStorage.setItem(CACHE_KEY, JSON.stringify(names));
          renderCompanyOptions(names, true);
          setStatus('Loaded company list ‚úì', 'ok');
        }else{
          throw new Error('Invalid list payload');
        }
      }catch(err){
        console.error(err);
        setStatus('Warning: cannot load company list (using cache if any)', 'warn');
      }
    }

    function renderCompanyOptions(names, clear){
      if(clear) companyList.innerHTML = '';
      // if no options yet, append all
      if(companyList.children.length === 0){
        const frag = document.createDocumentFragment();
        names.forEach(n => {
          const op = document.createElement('option');
          op.value = n;
          frag.appendChild(op);
        });
        companyList.appendChild(frag);
      }
    }

    // üëâ 3) Save draft to localStorage (optional)
    const DRAFT_KEY = 'weekly-checkin-draft';
    document.getElementById('saveDraft').addEventListener('click', ()=>{
      const data = Object.fromEntries(new FormData(form).entries());
      localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
      setStatus('Draft saved locally ‚úì', 'ok');
    });
    window.addEventListener('load', ()=>{
      const raw = localStorage.getItem(DRAFT_KEY);
      if(raw){
        try{ const data = JSON.parse(raw); for(const k in data){ if(form[k]) form[k].value = data[k]; } }catch(e){}
      }
      loadCompanies();
    });

   // üëâ 4) Submit to Apps Script endpoint (debug friendly)
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  setStatus('Submitting‚Ä¶', 'warn');
  const btn = form.querySelector('button[type="submit"]');
  btn.disabled = true;

  const payload = Object.fromEntries(new FormData(form).entries());

  try{
    const res = await fetch(ENDPOINT_SUBMIT, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // simple request
      body: JSON.stringify(payload)
    });

    const ct = res.headers.get('content-type') || '';
    const statusInfo = `HTTP ${res.status} ‚Ä¢ CT=${ct}`;

    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡πà‡∏≤‡∏ô JSON ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô text
    if (ct.includes('application/json')) {
      const json = await res.json();
      if (res.ok && json && json.ok) {
        setStatus('Submitted ‚úì', 'ok');
        form.reset();
      } else {
        const msg = json && (json.error || JSON.stringify(json));
        setStatus(`Server error: ${msg} (${statusInfo})`, 'err');
      }
    } else {
      const text = await res.text();
      setStatus(`Non-JSON response: ${text.slice(0,180)}‚Ä¶ (${statusInfo})`, 'err');
    }
  }catch(err){
    setStatus(`Network error: ${err.message}`, 'err');
    console.error('Submit error:', err);
  }finally{
    btn.disabled = false;
  }
});
  </script>
</body>
</html>
