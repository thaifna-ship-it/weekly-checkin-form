<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer Check-in ‚Ä¢ Weekly & Monthly</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#334155;--border:#1f2937;--fg:#e5e7eb;--acc:#22c55e;--warn:#f59e0b;--err:#ef4444}
    html,body{background:#0b1220;color:var(--fg);font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:40px auto;padding:24px}
    .card{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid var(--border);border-radius:18px;padding:24px;box-shadow:0 10px 30px #0003}
    h1{font-size:1.6rem;margin:0 0 8px}
    p.desc{color:#94a3b8;margin:0 0 14px}
    .toprow{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);color:#9ca3af}
    .modeSel{background:#0b1220;border:1px solid var(--border);color:var(--fg);padding:10px;border-radius:10px}
    form{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full{grid-column:1/-1}
    label{display:block;font-size:.9rem;margin-bottom:6px;color:#cbd5e1}
    input,select,textarea,button{width:100%;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--fg);padding:12px}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .hint{font-size:.8rem;color:#94a3b8;margin-top:6px}
    .actions{display:flex;gap:12px}
    .btn{cursor:pointer;font-weight:600}
    .primary{background:linear-gradient(90deg,#16a34a,#22c55e);border:0;color:#062d13}
    .ghost{background:#0b1220;border-color:#263143}
    .status{margin-top:10px}
    .ok{color:var(--acc)}
    .warn{color:var(--warn)}
    .err{color:var(--err)}
    .footer{margin-top:20px;color:#94a3b8;font-size:.85rem}
    .checkboxes{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .checkboxes label{display:flex;align-items:center;gap:8px;margin:0}
    .checkboxes input[type="checkbox"], .checkline input[type="checkbox"]{width:auto}
    .checkline{display:flex;align-items:center;gap:8px;justify-content:flex-start;margin-top:4px}
    [hidden]{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Customer Check-in</h1>
      <p class="desc">‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î Weekly / Monthly ‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>

      <div class="toprow">
        <div class="pill">üß≠ Mode: <b id="modeBadge">Weekly</b></div>
        <select id="modeSel" class="modeSel">
          <option value="weekly" selected>Weekly</option>
          <option value="monthly">Monthly</option>
        </select>
      </div>
        <select id="modeSel" class="modeSel">
          <option value="weekly" selected>Weekly</option>
          <option value="monthly">Monthly</option>
        </select>
        <span id="status" class="status"></span>
      </div>

      <!-- WEEKLY FORM -->
      $1
          <span id="statusW" class="status"></span>$2</div>
      </form>

      <!-- MONTHLY FORM -->
      $1
          <span id="statusM" class="status"></span>$2</div>
      </form>

      <div class="footer">
        ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ <code>ENDPOINT_SUBMIT</code> ‡πÅ‡∏•‡∏∞ <code>ENDPOINT_LIST</code> ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó <b>CustomerList</b>
      </div>
    </div>
  </div>

  <script>
    // üëâ ENDPOINT ‡∏Ç‡∏≠‡∏á Apps Script (Web App /exec)
    const ENDPOINT_SUBMIT = "https://script.google.com/macros/s/AKfycbxP23knkjLauzdu8n7mRE7aORxmxayQzsElpyZ2Qd8SSIyZcAzjSbq6VrJq9U0APGY/exec"; // doPost
    const ENDPOINT_LIST   = "https://script.google.com/macros/s/AKfycbxP23knkjLauzdu8n7mRE7aORxmxayQzsElpyZ2Qd8SSIyZcAzjSbq6VrJq9U0APGY/exec"; // doGet (returns {names:[]})

    // Elements
    const modeSel   = document.getElementById('modeSel');
    const modeBadge = document.getElementById('modeBadge');
    const formW     = document.getElementById('formWeekly');
    const formM     = document.getElementById('formMonthly');
    const companyListW = document.getElementById('companyListW');
    c

    function setStatus(msg, cls){ statusEl.textContent = msg; statusEl.className = 'status ' + (cls||''); }

    // Toggle Other text input
    adsOtherChk?.addEventListener('change', ()=>{
      adsOtherText.style.display = adsOtherChk.checked ? 'block' : 'none';
      if (!adsOtherChk.checked) adsOtherText.value = '';
    });

    // Mode switch
    modeSel.addEventListener('change', ()=>{
      const m = modeSel.value;
      modeBadge.textContent = m.charAt(0).toUpperCase() + m.slice(1);
      const isMonthly = m === 'monthly';
      formM.hidden = !isMonthly;
      formW.hidden = isMonthly;
      setStatus('', '');
    });

    // Init Month default + load companies + drafts
    window.addEventListener('load', ()=>{
      const ymInput = formM.elements['ym'];
      if (ymInput && !ymInput.value) {
        const d = new Date();
        ymInput.value = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
      }
      loadCompanies();
      loadDrafts();
    });

    // Load company list (cache)
    const CACHE_KEY = 'company-names-cache-v1';
    async function loadCompanies(){
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        try { const names = JSON.parse(cached); renderCompanyOptions(names); } catch(_){}
      }
      try{
        const res = await fetch(ENDPOINT_LIST + '?t=' + Date.now(), { method:'GET' });
        const ct = res.headers.get('content-type')||'';
        if(!res.ok || !ct.includes('application/json')){ const text = await res.text(); throw new Error(`Bad response: ${res.status} ${ct} ${text.slice(0,120)}`); }
        const json = await res.json();
        const names = Array.isArray(json.names) ? [...new Set(json.names)].sort((a,b)=>a.localeCompare(b)) : [];
        localStorage.setItem(CACHE_KEY, JSON.stringify(names));
        renderCompanyOptions(names, true);
        setStatus('Loaded company list ‚úì','ok');
      }catch(err){ console.error('loadCompanies failed:', err); setStatus('Warning: cannot load company list (cache used)','warn'); }
    }
    function renderCompanyOptions(names, clear){
      if (clear){ companyListW.innerHTML = ''; companyListM.innerHTML=''; }
      if (companyListW.children.length===0){
        const fragW = document.createDocumentFragment();
        const fragM = document.createDocumentFragment();
        names.forEach(n=>{ const opW=document.createElement('option'); opW.value=n; fragW.appendChild(opW);
                           const opM=document.createElement('option'); opM.value=n; fragM.appendChild(opM); });
        companyListW.appendChild(fragW); companyListM.appendChild(fragM);
      }
    }

    // Drafts
    document.getElementById('saveDraftW').addEventListener('click', ()=>{
      const data = Object.fromEntries(new FormData(formW).entries());
      localStorage.setItem('weekly-checkin-draft', JSON.stringify(data));
      setStatus('Weekly draft saved ‚úì','ok');
    });
    document.getElementById('saveDraftM').addEventListener('click', ()=>{
      const data = Object.fromEntries(new FormData(formM).entries());
      data.inquiryDownload = inquiryDownloadChk.checked;
      data.adsServices = getSelectedAds();
      data.adsOtherText = adsOtherText.value || '';
      localStorage.setItem('monthly-report-draft-v1', JSON.stringify(data));
      setStatus('Monthly draft saved ‚úì','ok');
    });
    function loadDrafts(){
      const rw = localStorage.getItem('weekly-checkin-draft');
      if (rw) { try{ const d=JSON.parse(rw); for(const k in d){ if(formW[k]) formW[k].value=d[k]; } }catch(_){} }
      const rm = localStorage.getItem('monthly-report-draft-v1');
      if (rm) { try{ const d=JSON.parse(rm); for(const k in d){ if(formM[k] && typeof d[k]==='string') formM[k].value=d[k]; }
        inquiryDownloadChk.checked = !!d.inquiryDownload;
        if (Array.isArray(d.adsServices)){
          const checks = document.querySelectorAll('#adsGroup input[type="checkbox"]');
          checks.forEach(ch=> ch.checked = d.adsServices.includes(ch.value));
        }
        if (d.adsOtherText){ adsOtherChk.checked=true; adsOtherText.style.display='block'; adsOtherText.value=d.adsOtherText; }
      }catch(_){} }
    }

    function getSelectedAds(){
      const checks = document.querySelectorAll('#adsGroup input[type="checkbox"]');
      const list=[]; checks.forEach(ch=>{ if(ch.checked) list.push(ch.value); });
      return list;
    }

    // Submit helpers (simple request: text/plain)
    async function postJsonSimple(url, payload){
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload) });
      const ct = res.headers.get('content-type')||'';
      if (!res.ok || !ct.includes('application/json')){ const text = await res.text(); throw new Error(`Bad response: ${res.status} ${ct} ${text.slice(0,160)}`); }
      const json = await res.json();
      if (!json || !json.ok) throw new Error(json && json.error ? json.error : 'Server rejected');
      return json;
    }

    formW.addEventListener('submit', async (e)=>{
      e.preventDefault(); setStatus('Submitting weekly‚Ä¶','warn');
      const btn = formW.querySelector('button[type="submit"]'); btn.disabled = true;
      const payload = Object.fromEntries(new FormData(formW).entries());
      payload.mode = 'weekly';
      try{ await postJsonSimple(ENDPOINT_SUBMIT, payload); setStatus('Weekly submitted ‚úì','ok'); formW.reset(); }
      catch(err){ console.error(err); setStatus('Error (weekly): '+err.message,'err'); }
      finally{ btn.disabled=false; }
    });

    formM.addEventListener('submit', async (e)=>{
      e.preventDefault(); setStatus('Submitting monthly‚Ä¶','warn');
      const btn = formM.querySelector('button[type="submit"]'); btn.disabled = true;
      const data = Object.fromEntries(new FormData(formM).entries());
      const payload = {
        mode: 'monthly',
        ym: data.ym?.trim(),
        staff: data.staff?.trim(),
        company: data.company?.trim(),
        relationshipMonthly: Number(data.relationshipMonthly||0),
        proactivenessMonthly: Number(data.proactivenessMonthly||0),
        listingCompleteness: data.listingCompleteness,
        knowledgeStatus: data.knowledgeStatus,
        knowledgePieces: Number(data.knowledgePieces||0),
        knowledgeNotes: data.knowledgeNotes||'',
        adsServices: getSelectedAds(),
        inquiryDownload: !!inquiryDownloadChk.checked,
        monthlyMemo: data.monthlyMemo||'',
        nextActionNextMonth: data.nextActionNextMonth||''
      };
      try{ await postJsonSimple(ENDPOINT_SUBMIT, payload); setStatus('Monthly submitted ‚úì','ok'); formM.reset();
        const d=new Date(); formM.ym.value=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0'); adsOtherText.style.display='none';}
      catch(err){ console.error(err); setStatus('Error (monthly): '+err.message,'err'); }
      finally{ btn.disabled=false; }
    });
  </script>
</body>
</html>
